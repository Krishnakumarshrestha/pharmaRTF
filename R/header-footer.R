library(assertthat)

## Title line container ----
hf_line <- function(..., align=c('center', 'left', 'right', 'split'), bold=FALSE,
                    italic=FALSE, font=NA, font_size=NaN, index=NULL) {

  ## TODO: Come back to this and rebuild following recommended practice:
  ##       -> https://adv-r.hadley.nz/s3.html#s3-classes Section 13.3.1
  line = list()

  line$text <- unlist(list(...))

  # Make sure alignment is valid
  align <- match.arg(align)

  # Check that no more than two entries were provided
  assert_that(length(line$text) <= 2, msg="No more than two entries may be provided per line")

  # Check that if the alignment was split, that two entries were provided
  assert_that({
    if (align == 'split') length(line$text) == 2
    else TRUE
  }, msg = "Two text entries must be provided if alignment is 'split', otherwise only one may be entered.")

  # Make sure the other arguments are logicals
  sapply(c(bold, italic), function(x) assert_that(is.logical(x)))

  # Make sure index is numeric or null
  assert_that(is.numeric(index) | is.null(index))

  # Make sure font is character
  assert_that(is.character(font) | is.na(font))

  # Make sure font size is numeric
  assert_that(is.numeric(font_size))

  # Assign attributes
  attr(line, 'align') <- align
  attr(line, 'bold') <- bold
  attr(line, 'italic') <- italic
  attr(line, 'font') <- font
  attr(line, 'font_size') <- font_size
  attr(line, 'index') <- index

  # Assign the class
  class(line) <- 'hf_line'
  line
}

# Internal function - do not export
order_lines <- function(lines) {

  # Take out the indices
  inds <- unlist(sapply(lines, FUN=attr, which='index'))

  # Make sure no indices are duplicated
  assert_that(
    !any(duplicated(inds)),
    msg = "Duplicate indices provided - ensure that provided indices are unique or NULL"
  )

  # Grab the nulls
  new_lines <- Filter(function(x) is.null(attr(x, 'index')), lines)

  # Sort the indices and reverse the order
  for (i in rev(sort(inds))) {
    # Append the items in order to the front of the list - this results in ordered lines with nulls at the back
    new_lines <- append(new_lines, pharmaRTF:::Filter(pharmaRTF:::extract_ind, lines, i=i), after=0)
  }

  new_lines
}

# rtf_doc method
add_hf <- function(doc, ..., to=NULL, replace=FALSE) {

  # Get lines from doc (if specified to replace)
  if (!replace) {
    lines = doc[[to]]
    lines <- append(lines, list(...))
  } else {
    lines <- list(...)
  }

  # Make sure each provided object is an hf_line
  assert_that(all(sapply(lines, inherits, what='hf_line')),
              msg = 'Provided titles must be hf_line objects- see pharmaRTF::hf_line')

  # Sort
  lines <- pharmaRTF:::order_lines(lines)

  # Add to the document object
  doc[[to]] <- lines

  doc

}

# Simplified for titles
add_titles <- function(doc, ...) {
  pharmaRTF:::add_hf(doc, ..., to='titles')
}

# Simplified for footnoes
add_footnotes <- function(doc, ...) {
  pharmaRTF:::add_hf(doc, ..., to='footnotes')
}
